# Expansion Manager Security Validation Pipeline
# Ensures expansion_manager role cannot breach security boundaries

name: Expansion Security Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/lib/auth/**'
      - 'config/**'  
      - 'database/migrations/**'
      - '__tests__/authz-comprehensive/**'
  push:
    branches: [main]

env:
  NODE_VERSION: '20'
  POSTGRES_VERSION: '15'

jobs:
  expansion-authz-tests:
    name: Expansion Manager Authorization Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: xpress_test
          POSTGRES_DB: xpress_authz_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        run: |
          npm run db:migrate
        env:
          DATABASE_URL: postgresql://xpress_test:test_password@localhost:5432/xpress_authz_test

      - name: Start test API server
        run: |
          npm run test:api:start &
          sleep 5
          curl -f http://localhost:4001/healthz || exit 1

      - name: Run expansion manager security tests
        run: |
          newman run __tests__/authz-comprehensive/postman/xpress-authz-api-tests.json \
            -e __tests__/authz-comprehensive/postman/environment.json \
            --folder "Expansion Manager Role Tests" \
            --reporters cli,json \
            --reporter-json-export expansion-results.json \
            --bail \
            --timeout-request 30000

      - name: Validate expansion scope boundaries
        run: |
          # Ensure T-11 through T-15 all pass
          node -e "
            const results = require('./expansion-results.json');
            const failures = results.run.failures;
            
            if (failures.length > 0) {
              console.error('‚ùå Expansion tests failed:', failures.length, 'failures');
              failures.forEach(f => console.error('  -', f.error.message));
              process.exit(1);
            }
            
            console.log('‚úÖ All expansion manager tests passed');
          "

      - name: Security boundary validation
        run: |
          # Ensure expansion_manager cannot access active/suspended regions
          node -e "
            const results = require('./expansion-results.json');
            const testResults = results.run.executions;
            
            // Find T-14 test (Active Region Access Denied)
            const t14 = testResults.find(t => 
              t.item.name.includes('T-14: Active Region Access Denied')
            );
            
            if (!t14 || t14.response.code !== 403) {
              console.error('‚ùå SECURITY BREACH: expansion_manager can access active regions');
              process.exit(1);
            }
            
            console.log('‚úÖ Expansion scope boundaries enforced');
          "

      - name: Archive test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: expansion-test-results
          path: |
            expansion-results.json
            __tests__/authz-comprehensive/results/

  static-security-analysis:
    name: Static Security Analysis for Expansion Role
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate expansion permissions
        run: |
          node -e "
            const actions = require('./config/allowed-actions.json');
            const expansionPerms = actions.expansion_manager;
            
            // Forbidden permissions for expansion_manager
            const forbidden = [
              'unmask_pii_with_mfa', 'manage_users', 'assign_roles',
              'approve_payroll', 'process_payments', 'access_hr_records',
              'modify_active_pricing', 'suspend_region', 'delete_region'
            ];
            
            const violations = forbidden.filter(perm => 
              expansionPerms.includes(perm)
            );
            
            if (violations.length > 0) {
              console.error('‚ùå SECURITY VIOLATION: expansion_manager has forbidden permissions:', violations);
              process.exit(1);
            }
            
            console.log('‚úÖ Expansion manager permissions validated');
          "

      - name: Validate region state enforcement
        run: |
          grep -r "expansion_manager.*active\|expansion_manager.*suspended" src/ && {
            echo "‚ùå SECURITY VIOLATION: expansion_manager accessing active/suspended regions in code"
            exit 1
          } || {
            echo "‚úÖ No hardcoded expansion access to active regions"
          }

  build-fail-conditions:
    name: Build Failure Conditions
    runs-on: ubuntu-latest
    needs: [expansion-authz-tests, static-security-analysis]
    if: failure()
    
    steps:
      - name: Fail build with security context
        run: |
          echo "üö® BUILD FAILED: Expansion Manager Security Violation Detected"
          echo ""
          echo "Possible causes:"
          echo "‚Ä¢ Expansion tests (T-11 ‚Üí T-15) are failing"
          echo "‚Ä¢ expansion_manager can access active/suspended regions" 
          echo "‚Ä¢ Forbidden permissions assigned to expansion_manager"
          echo "‚Ä¢ Security boundaries compromised"
          echo ""
          echo "Required fixes:"
          echo "‚Ä¢ All expansion tests must pass"
          echo "‚Ä¢ expansion_scope_ok() must block active/suspended access"
          echo "‚Ä¢ Policy bundle must restrict expansion permissions"
          echo ""
          exit 1