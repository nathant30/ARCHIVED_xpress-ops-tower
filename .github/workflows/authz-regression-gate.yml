name: AuthZ Regression Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main, develop]
    paths:
      - 'src/lib/auth/**'
      - 'config/allowed-actions.json'
      - '__tests__/authz-comprehensive/**'
      - 'src/types/rbac-abac.ts'
  push:
    branches: [main]
    paths:
      - 'src/lib/auth/**'
      - 'config/allowed-actions.json'

jobs:
  # Marks workflow as success when PR is docs-only
  docs_only_pass:
    if: contains(github.event.pull_request.labels.*.name, 'docs-only')
    runs-on: ubuntu-latest
    steps:
      - run: echo "docs-only PR ‚Üí skipping AuthZ suite"

  authz-critical-tests:
    # Run on push OR on PRs that are NOT docs-only
    if: ${{ github.event_name == 'push' || !contains(github.event.pull_request.labels.*.name, 'docs-only') }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install -g newman

      - name: Setup test environment
        run: |
          mkdir -p /tmp
          echo "Setting up AuthZ test environment..."

      - name: Run AuthZ Regression Gate
        id: authz_gate
        env:
          CI: true
          NODE_ENV: test
        run: |
          echo "üîí Running Critical Authorization Tests"
          ./scripts/ci-authz-gate.sh

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: authz-test-failures-${{ matrix.node-version }}
          path: |
            /tmp/ci-newman.json
            /tmp/ci-api-server.log
            /tmp/authz-gate.log
          retention-days: 7

      - name: Comment PR with results
        if: ${{ github.event_name == 'pull_request' && always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ job.status }}';
            let comment = '## üîí AuthZ Regression Gate Results\n\n';
            if (outcome === 'success') {
              comment += '‚úÖ **All critical authorization tests passed**\n';
              comment += '- SQL RLS/DDM: 100% pass rate\n';
              comment += '- RBAC Permission Matrix: All validations passing\n';
              comment += '- MFA Enforcement: All flows validated\n';
              comment += '- Cross-Region Override: Boundary checks passing\n';
              comment += '- API Integration: Critical endpoints validated\n\n';
              comment += 'üéâ **No authorization regressions detected - safe to merge**';
            } else {
              comment += '‚ùå **Authorization regression detected - BLOCKING MERGE**\n\n';
              comment += '‚ö†Ô∏è One or more critical authorization tests failed.\n\n';
              comment += '**Common Issues:**\n';
              comment += '- Policy bundle hash mismatch\n';
              comment += '- MFA session TTL violations\n';
              comment += '- Cross-region override logic errors\n';
              comment += '- SQL RLS/DDM policy corruption\n';
              comment += '- Permission matrix validation failures\n\n';
              comment += 'üîç Check the workflow logs for detailed failure analysis.';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  policy-bundle-validation:
    if: ${{ github.event_name == 'push' || !contains(github.event.pull_request.labels.*.name, 'docs-only') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Policy Bundle Integrity
        run: |
          echo "üîç Validating policy bundle integrity..."
          node -e "
          const { createPolicyBundle, validatePolicyBundle } = require('./src/lib/auth/policy-bundle.ts');
          const bundle = createPolicyBundle();
          const validation = validatePolicyBundle(bundle);
          console.log('Policy Bundle:', bundle.version, bundle.hash);
          console.log('Validation:', validation);
          if (!validation.valid) {
            console.error('‚ùå Policy bundle validation failed:', validation.errors);
            process.exit(1);
          }
          console.log('‚úÖ Policy bundle is valid and ready for production');
          "

      - name: Check for Breaking Changes
        run: |
          echo "üîÑ Checking for breaking policy changes..."
          git fetch origin main
          if git diff --name-only origin/main..HEAD | grep -q "config/allowed-actions.json"; then
            echo "‚ö†Ô∏è Policy configuration changes detected"
            echo "Ensure version bump and compatibility testing"
          else
            echo "‚úÖ No breaking policy changes detected"
          fi

  security-scan:
    if: ${{ github.event_name == 'push' || !contains(github.event.pull_request.labels.*.name, 'docs-only') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Security Scan on Auth Code
        uses: github/codeql-action/analyze@v3
        with:
          languages: typescript
          queries: security-and-quality
          paths: |
            src/lib/auth/
            config/allowed-actions.json

      - name: Check for Hardcoded Secrets
        run: |
          echo "üîç Scanning for hardcoded secrets in auth code..."
          if grep -r -i -E "(password|secret|key|token).*=.*['\"][^'\"]{8,}" src/lib/auth/; then
            echo "‚ùå Potential hardcoded secrets detected"
            exit 1
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi
